<div class="hidden">
    {{{hidden}}}
</div>

<div class="col-md-12">
    <div class="box">
        <div class="box-body">
            <div id="zheader" class="row">
                {{{zheader}}}
            </div>
        </div>
    </div>
</div>

<div id="colfilter" class="col-md-12 hidden">
    <div class="box ">
        <!-- collapsed-box -->
        <div class="box-header">
            <i class="fa fa-filter"></i>
            <h3 class="box-title">Filtros</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-sm btn-default" data-widget="collapse">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="box-body">
            <!-- style="display: none;" -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Campo</label>
                        <select name="campo" class="form-control" style="width: 100%;">
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Operador</label>
                        <select name="operador" class="form-control" style="width: 100%;">
                                <option value="equals">Igual</option>
                                <option value="">Diferente</option>
                                <option value="">Contém</option>
                                <option value="">Não Contém</option>
                                
                                <option value="">Maior</option>
                                <option value="">Menor</option>

                                <option value="">Customizado</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Valor</label>
                        <input name="valor" class="form-control" style="width: 100%;"/>
                    </div>
                </div>
                <div class="col-md-1 no-padding-left">
                    <div class="form-group">
                        <label style="color: white">.</label>
                        <button type="button" class="btn btn-success" style="width: 100%;">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <table id="tablefilter" class="table table-bordered table-hover dataTable" width="100%">
            </table>
            <div id="zfilter" class="row">
                {{{zfilter}}}
            </div>
        </div>
    </div>
</div>

<div id="colpivot" class="col-md-12 hidden">
    <div class="box">
        <!-- <div class="box-header">
            <button type="button" class="btn btn-default btn-sm" title="Filtrar"><i class="fa fa-binoculars"></i></button>
            <button type="button" class="btn btn-default btn-sm" title="Filtrar"><i class="fa fa-bars"></i></button>
        </div> -->
        <div class="box-body">
            <div class="row">
                <div class="col-sm-12">
                    <div class="pivotdiv">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $pivot = $('.pivotdiv');
        application.functions.getCss([
            '/public/assets/pivotjs/c3.min.css'
            , '/public/assets/pivotjs/pivot.css'
        ]);
        application.functions.getJs([
            '/public/assets/jquery/jquery-ui.min.js'
            , '/public/assets/pivotjs/jquery.ui.touch-punch.min.js'
            , '/public/assets/pivotjs/pivot.js'
            , '/public/assets/pivotjs/pivot.pt.js'
            , '/public/assets/pivotjs/export_renderers.js'
            , '/public/assets/pivotjs/c3.min.js'
            , '/public/assets/pivotjs/c3_renderers.js'
            , '/public/assets/pivotjs/d3.min.js'
            , '/public/assets/pivotjs/d3_renderers.js'
        ]);

        var tablefilter = $('#tablefilter').DataTable({
            dom: 't'
            , columns: [
                { title: "Dimensão", data: "dimensao", name: "seq", orderable: false }
                , { title: "Operador", data: "operador", name: "operador", orderable: false }
                , { title: "Valor", data: "valor", name: "valor", orderable: false }
            ]
            , pageLength: -1
            , ordering: false
        })

        function renderPivot(obj) {
            $('#colfilter, #colpivot').removeClass('hidden');

            $('select[name="campo"]').find('option').remove();
            for (var i = 0; i < obj.filteravailable.length; i++) {
                $('select[name="campo"]').append('<option>' + obj.filteravailable[i] + '</option>');
            }

            eval(obj.measures);
            $pivot.pivotUI(
                obj.data
                , $.extend(
                    {
                        renderers: $.extend(
                            $.pivotUtilities.renderers
                            , $.pivotUtilities.c3_renderers
                        )
                        , aggregators: globalaggregator
                        , hiddenAttributes: obj.hiddenAttributes
                        , sorters: function (attr) {
                            if (attr.indexOf("(Mes)") >= 0) {
                                return $.pivotUtilities.sortAs([
                                    "Janeiro", "Fevereiro", "Março",
                                    "Abril", "Maio", "Junho",
                                    "Julho", "Agosto", "Setembro",
                                    "Outubro", "Novembro", "Dezembro"]);
                            }
                        }
                        , onRefresh: function (config) {
                            var keys = [
                                'hiddenAttributes'
                                , 'cols'
                                , 'rows'
                                , 'rowOrder'
                                , 'colOrder'
                                , 'exclusions'
                                , 'inclusions'
                                , 'inclusionsInfo'
                                , 'rendererName'
                                , 'aggregatorName'
                            ];
                            var config_copy = {};
                            for (var i = 0; i < keys.length; i++) {
                                config_copy[keys[i]] = config[keys[i]];
                            }
                            $('textarea[name="config"]').val(JSON.stringify(config_copy));
                        }
                    }
                    , JSON.parse($('textarea[name="config"]').val() || '{}')
                )
                , true
                , 'pt'
            );
        }

        $(document).on('app-loadjs', function () {

            var $idcube = $('select[name="idcube"]');
            $idcube.on('select2:select', function (e) {
                application.jsfunction('platform.core_bi.js_getCube', { idcube: e.params.data.id }, function (response) {
                    if (response.success) {
                        renderPivot(response.data);
                    }
                });
            });

            if (application.functions.getId() > 0) {
                application.jsfunction('platform.core_bi.js_getCube', { idcube: $idcube.val() }, function (response) {
                    if (response.success) {
                        renderPivot(response.data);
                    }
                });
            }

        });
    });

</script>